@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@inject IConfiguration Configuration
@{
    Layout = "_Layout";     // or your AdminLTE layout
}

<div class="content-wrapper">
    <div class="container-fluid py-4">
        <div class="text-center" id="currentStockTableLoader">
            <div class="spinner-border" role="status">
                <span class="visually-hidden"></span>
            </div>
        </div>
        <div class="card shadow-sm mx-auto" style="max-width: 1100px;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="card-title mb-0">Current Stock Report</h3>
                </div>

                <div class="table-responsive">
                    <table id="CurrentStockReport" class="table table-striped table-bordered w-100 text-center">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">S.L</th>
                                <th scope="col">Product Name</th>
                                <th scope="col">SKU</th>
                                <th scope="col">Price</th>
                                <th scope="col">Current Stock Quantity</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Get token from session storage
            var token = '@(HttpContextAccessor.HttpContext.Session.GetString("JWToken") ?? "")';
            var apiBaseUrl = "@Configuration["WebApiBaseUrl"]";
            $('#CurrentStockReport').DataTable({
                processing: false,
                serverSide: false,
                ajax: {
                    url: `${apiBaseUrl}/api/Report/CurrentStock`,
                    type: 'GET',
                    dataSrc: function (json) {
                        if (Array.isArray(json)) {
                            return json;
                        } else if (json && json.data) {
                            return json.data;
                        }
                        return [];
                    },
                    beforeSend: function (xhr) {
                        if (token) {
                            $('#currentStockTableLoader').show();
                            $('#CurrentStockReport').hide();
                            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                        }
                    },
                    complete: function () {
                        $('#currentStockTableLoader').hide();
                        $('#CurrentStockReport').show();
                    },
                    error: function (xhr, error, thrown) {
                        if (xhr.status === 401) {
                            toastr["error"]("Session expired!", "Please login again")
                            window.location.href = '/Account/Login';
                        }
                    }
                },
                columns: [
                    {
                        data: null,
                        title: 'S.L',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { data: 'productName', title: 'Product Name' },
                    { data: 'sku', title: 'SKU' },
                    {
                        data: 'price',
                        title: 'Price',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'currentStockQty',
                        title: 'Stock Status',
                        className: 'text-end',
                        render: function (data, type, row) {
                            if (type === 'display') {
                                const criticalStockThreshold = 10;
                                const lowStockThreshold = 20;

                                const stockQty = Number(data);

                                if (stockQty == 0) {
                                    return `
                                    <div class="d-flex justify-content-end align-items-center">
                                        <span class="text-danger fw-bold">
                                            <i class="fas fa-times-circle me-2"></i>
                                            ${stockQty} (Out of Stock)
                                        </span>
                                    </div>
                                `;
                                }
                                else if (stockQty > 0 && stockQty <= criticalStockThreshold) {
                                    return `
                                    <div class="d-flex justify-content-end align-items-center">
                                        <span class="text-danger fw-bold">
                                            <i class="fas fa-exclamation-circle me-2"></i>
                                            ${stockQty} (Critical)
                                        </span>
                                    </div>
                                `;
                                }
                                else if (stockQty > criticalStockThreshold && stockQty <= lowStockThreshold) {
                                    return `
                                    <div class="d-flex justify-content-end align-items-center">
                                        <span class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            ${stockQty} (Low)
                                        </span>
                                    </div>
                                `;
                                }
                                else if (stockQty >= lowStockThreshold) {
                                    return `
                                    <div class="d-flex justify-content-end align-items-center">
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            ${stockQty}
                                        </span>
                                    </div>
                                `;
                                }
                            }
                            return data; 
                        }
                    }
                ],
                paging: true,
                pageLength: 10,
                lengthChange: true,
                searching: true,
                ordering: true,
                responsive: true,
                language: {
                    emptyTable: "No products found in stock",
                    processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>'
                }
            });

            // Create Sales button click handler
            $('#createSales').click(function () {
                window.location.href = '/Sales/Create';
            });
        });
    </script>
}

